<!--
***********************************************************************************************
Microsoft.NET.PackTool.targets

WARNING:  DO NOT MODIFY this file unless you are knowledgeable about MSBuild and have
          created a backup copy.  Incorrect changes to this file will make it
          impossible to load or build your projects from the command-line or the IDE.

Copyright (c) .NET Foundation. All rights reserved. 
***********************************************************************************************
-->

<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <UsingTask TaskName="Microsoft.NET.Build.Tasks.GenerateToolsSettingsFile"
              AssemblyFile="$(MicrosoftNETBuildTasksAssembly)" />

  <Target Name="PackTool" DependsOnTargets="AddToolsSettingsFilePathToPackContent;Publish" Condition=" '$(PackAsTool)' == 'true' ">
    <ItemGroup>
      <!--TODO wul do not glob-->
      <TfmSpecificPackageFiles Include="$(PublishDir)/**/*.*"/>
    </ItemGroup>
    <!--All published file in different tools/tfm-->
    <ItemGroup>
      <TfmSpecificPackageFile Include="@(TfmSpecificPackageFiles)">
        <PackagePath>tools/$(targetframework)/any/%(TfmSpecificPackageFiles.RecursiveDir)%(TfmSpecificPackageFiles.Filename)%(TfmSpecificPackageFiles.Extension)</PackagePath>
      </TfmSpecificPackageFile>
    </ItemGroup>
  </Target>
  
  <Target Name="AddToolsSettingsFilePathToPackContent" DependsOnTargets="GenerateToolsSettingsFileFromBuildProperty" Condition="'$(_ToolSettingsFileIncluded)' == '' " >    
    <ItemGroup>
      <TfmSpecificPackageFile Include="$(ToolsSettingsFilePath)">
        <PackagePath>tools/DotnetToolSettings.xml</PackagePath>
        <BuildAction>none</BuildAction>
      </TfmSpecificPackageFile>
    </ItemGroup>
    
    <PropertyGroup>
      <!--Only need to include Settings file once for all TFMs-->
      <_ToolSettingsFileIncluded>true</_ToolSettingsFileIncluded>
    </PropertyGroup>
  </Target>
  
  <Target Name="GenerateToolsSettingsFileFromBuildProperty" >
    <PropertyGroup>
      <ToolsSettingsFilePath>$(BaseIntermediateOutputPath)$(Configuration)/DotnetToolSettings.xml</ToolsSettingsFilePath>
    </PropertyGroup>
       
    <GenerateToolsSettingsFile
       EntryPointRelativePath="$(TargetFileName)"
       CommandName="$(TargetName)"
       ToolsSettingsFilePath="$(ToolsSettingsFilePath)" />
  </Target>
</Project>
