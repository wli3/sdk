<!--
***********************************************************************************************
Microsoft.NET.GenerateAppConfig.targets

WARNING:  DO NOT MODIFY this file unless you are knowledgeable about MSBuild and have
          created a backup copy.  Incorrect changes to this file will make it
          impossible to load or build your projects from the command-line or the IDE.

Copyright (c) .NET Foundation. All rights reserved.
***********************************************************************************************
-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <UsingTask TaskName="WriteAppConfig" AssemblyFile="$(MicrosoftNETBuildTasksAssembly)" />
  <UsingTask TaskName="SetGeneratedAppConfigMetadata" AssemblyFile="$(MicrosoftNETBuildTasksAssembly)" />

  <PropertyGroup>
    <_GenerateAppConfigIntermediateAppConfig>$(IntermediateOutputPath)$(TargetFileName).withSupportedRuntime.config</_GenerateAppConfigIntermediateAppConfig>
  </PropertyGroup>

  <Target Name="GenerateAppConfig"
          Condition="'$(GenerateAppConfig)' != 'false' and '$(TargetFrameworkIdentifier)' == '.NETFramework' and '$(HasRuntimeOutput)' == 'true'"
          DependsOnTargets="_WriteAppConfig"
          BeforeTargets="GenerateBindingRedirects">

    <SetGeneratedAppConfigMetadata
     AppConfigFile="@(AppConfigWithTargetPath)"
     TargetName="$(TargetFileName).config"
     GeneratedAppConfigFile="$(_GenerateAppConfigIntermediateAppConfig)"
      >

      <Output TaskParameter="OutputAppConfigFileWithMetadata" ItemName="_GenerateAppConfigAppConfigWithTargetPath" />
    </SetGeneratedAppConfigMetadata>

    <!--Override the AppConfigWithTargetPath for downstream target-->
    <ItemGroup>
      <AppConfigWithTargetPath Remove="@(AppConfigWithTargetPath)" />
      <AppConfigWithTargetPath Include="@(_GenerateAppConfigAppConfigWithTargetPath)" />
    </ItemGroup>

  </Target>

  <Target Name="_WriteAppConfig"
          Inputs="$(MSBuildAllProjects);@(AppConfigWithTargetPath);$(ResolveAssemblyReferencesStateFile)"
          Outputs="$(_GenerateAppConfigIntermediateAppConfig)"
          DependsOnTargets="PrepareForBuild">

    <WriteAppConfig
      AppConfigFile="@(AppConfigWithTargetPath)"
      TargetFrameworkIdentifier="$(TargetFrameworkIdentifier)"
      TargetFrameworkVersion="$(TargetFrameworkVersion)"
      TargetFrameworkProfile="$(TargetFrameworkProfile)"
      OutputAppConfigFile="$(_GenerateAppConfigIntermediateAppConfig)"
      >
    </WriteAppConfig>

    <ItemGroup>
      <FileWrites Include="@(_GenerateAppConfigAppConfigWithTargetPath)"/>
    </ItemGroup>

  </Target>

</Project>
